name: Build

on:
  workflow_dispatch:
    inputs:
      env:
        description: 'Set environment (alpha, dev, staging)'
        required: true
        default: 'alpha'

env:
  FOLDER_PATH: /home/c8prod/captiv8.io
  ALPHA: c8prod@platform.alpha.captiv8.io
  DEVELOP: c8prod@platform.dev.captiv8.io
  STAGING: c8prod@platform.staging.captiv8.io

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Connect to the server
        uses: appleboy/ss
        run: |
          ssh -p 2200 c8prod@platform.{{ github.event.inputs.env }}.captiv8.io
          cd {{ env.FOLDER_PATH }}
      - name: Git checkout
        uses: actions/checkout@v3
      - name: composer install
        run: composer install
      - name: Migration
        run: php artisan migrate --force
      - name: Compilation
        run: php artisan clear-compiled
      - name: cache clear
        run: php artisan cache:clear
      - name: restart
        run: php artisan queue:restart
